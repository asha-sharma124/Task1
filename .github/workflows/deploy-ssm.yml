name: Single Instance Blue-Green Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  BLUE_TG_ARN: ${{ secrets.BLUE_TARGET_GROUP_ARN }}
  GREEN_TG_ARN: ${{ secrets.GREEN_TARGET_GROUP_ARN }}
  ALB_LISTENER_ARN: ${{ secrets.ALB_LISTENER_ARN }}
  LAUNCH_TEMPLATE_ID: ${{ secrets.LAUNCH_TEMPLATE_ID }}
  PRIVATE_SUBNET_ID: ${{ secrets.PRIVATE_SUBNET_ID }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - id: set_tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=v${{ github.run_number }}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v2
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Database image
        uses: docker/build-push-action@v4
        with:
          context: ./db
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-db:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-db:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-db:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-db:buildcache,mode=max

      - name: Build and push API image
        uses: docker/build-push-action@v4
        with:
          context: ./api
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-api:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-api:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-api:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-api:buildcache,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/quotes-frontend:buildcache,mode=max

      - name: Upload deployment files to S3
        run: |
          sed -i "s|build: ./db|image: ${{ secrets.DOCKER_USERNAME }}/quotes-db:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml
          sed -i "s|build: ./api|image: ${{ secrets.DOCKER_USERNAME }}/quotes-api:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml
          sed -i "s|build: ./app|image: ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml

          aws s3 cp docker-compose.yml s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ steps.set_tag.outputs.tag }}/
          aws s3 cp nginx-config/ s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ steps.set_tag.outputs.tag }}/nginx-config/ --recursive
          aws s3 cp deployment/ s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ steps.set_tag.outputs.tag }}/deployment/ --recursive
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  provision-green:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      green_instance_id: ${{ steps.launch.outputs.instance_id }}
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - id: launch
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --launch-template LaunchTemplateId=${{ env.LAUNCH_TEMPLATE_ID }} \
            --count 1 --subnet-id ${{ env.PRIVATE_SUBNET_ID }} \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Environment,Value=green},{Key=Version,Value=${{ needs.build.outputs.image_tag }}},{Key=Name,Value=quotes-app-green}]" \
            --query 'Instances[0].InstanceId' --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.launch.outputs.instance_id }}
          sleep 150

  deploy:
    needs: provision-green
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy via SSM
        run: |
          echo "=== Deploying to green instance ==="
          echo "Instance ID: ${{ needs.provision-green.outputs.green_instance_id }}"
          echo "Image Tag: ${{ needs.build.outputs.image_tag }}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ needs.provision-green.outputs.green_instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy quotes app ${{ needs.build.outputs.image_tag }}" \
            --timeout-seconds 1800 \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -ex",
              "echo \"=== Deployment Started at $(date) ===\"",
              "sudo mkdir -p /home/ubuntu/quotes-app/deployment /home/ubuntu/quotes-app/nginx-config",
              "sudo chown -R ubuntu:ubuntu /home/ubuntu/quotes-app",
              "cd /home/ubuntu/quotes-app",
              "pwd",
              "echo \"AWS CLI: $(aws --version)\"",
              "echo \"Docker: $(docker --version)\"",
              "echo \"Docker Compose: $(docker-compose --version)\"",
              "",
              "echo \"Downloading files from S3...\"",
              "aws s3 cp s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ needs.build.outputs.image_tag }}/docker-compose.yml .",
              "aws s3 cp s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ needs.build.outputs.image_tag }}/nginx-config/ ./nginx-config/ --recursive",
              "aws s3 cp s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ needs.build.outputs.image_tag }}/deployment/ ./deployment/ --recursive",
              "",
              "chmod +x deployment/*.sh",
              "echo \"Files downloaded:\"",
              "ls -la deployment",
              "",
              "echo \"Starting deployment script...\"",
              "bash deployment/deploy.sh ${{ secrets.DOCKER_USERNAME }} ${{ needs.build.outputs.image_tag }} ${{ secrets.DOCKER_PASSWORD }} green",
              "",
              "echo \"=== Deployment Finished at $(date) ===\""
            ]' \
            --query 'Command.CommandId' \
            --output text)

          echo "Command ID: $COMMAND_ID"
          echo "Polling deployment status (max 15 minutes)..."

          MAX_ATTEMPTS=120
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESULT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" \
              --region ${{ env.AWS_REGION }} 2>/dev/null || echo '{"Status":"Pending"}')

            STATUS=$(echo "$RESULT" | jq -r '.Status')
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS - Time: $(date +%H:%M:%S)"

            if [ "$STATUS" = "Success" ]; then
              echo ""
              echo "✅ Deployment successful!"
              echo ""
              echo "=== Deployment Output ==="
              echo "$RESULT" | jq -r '.StandardOutputContent'
              exit 0
            fi

            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              echo ""
              echo "❌ Deployment failed with status: $STATUS"
              echo ""
              echo "=== Standard Output ==="
              echo "$RESULT" | jq -r '.StandardOutputContent'
              echo ""
              echo "=== Standard Error ==="
              echo "$RESULT" | jq -r '.StandardErrorContent'
              exit 1
            fi

            sleep 15
          done

          echo ""
          echo "❌ Deployment timeout after 15 minutes"
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" \
            --region ${{ env.AWS_REGION }})
          echo "$RESULT" | jq -r '.StandardOutputContent'
          exit 1


  register-green:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - run: |
          aws elbv2 register-targets --target-group-arn ${{ env.GREEN_TG_ARN }} --targets Id=${{ needs.provision-green.outputs.green_instance_id }}

          MAX_ATTEMPTS=40
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            HEALTH_INFO=$(aws elbv2 describe-target-health --target-group-arn ${{ env.GREEN_TG_ARN }} --targets Id=${{ needs.provision-green.outputs.green_instance_id }} 2>/dev/null || echo '{"TargetHealthDescriptions":[{"TargetHealth":{"State":"unknown"}}]}')
            STATE=$(echo "$HEALTH_INFO" | jq -r '.TargetHealthDescriptions[0].TargetHealth.State // "unknown"')
            if [ "$STATE" = "healthy" ] || [ "$STATE" = "unused" ]; then exit 0; fi
            sleep 30
          done
          exit 1

  configure-canary:
    needs: register-green
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - run: |
          aws elbv2 modify-listener \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,ForwardConfig="{
              TargetGroups=[
                {TargetGroupArn=${{ env.BLUE_TG_ARN }},Weight=80},
                {TargetGroupArn=${{ env.GREEN_TG_ARN }},Weight=20}
              ],
              TargetGroupStickinessConfig={Enabled=false}
            }"

  approve:
    needs: configure-canary
    runs-on: ubuntu-latest
    environment: production-approval
    steps:
      - run: echo "Deployment paused for QA testing. Awaiting approval."

  complete-deployment:
    needs: approve
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - id: blue
        run: |
          BLUE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=blue" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null || echo "")
          echo "blue_id=$BLUE_ID" >> $GITHUB_OUTPUT

      - run: |
          aws elbv2 modify-listener --listener-arn ${{ env.ALB_LISTENER_ARN }} --default-actions Type=forward,TargetGroupArn=${{ env.GREEN_TG_ARN }}

      - run: |
          if [ "${{ steps.blue.outputs.blue_id }}" != "" ] && [ "${{ steps.blue.outputs.blue_id }}" != "None" ]; then
            aws elbv2 deregister-targets --target-group-arn ${{ env.BLUE_TG_ARN }} --targets Id=${{ steps.blue.outputs.blue_id }}
            sleep 30
            aws ec2 terminate-instances --instance-ids ${{ steps.blue.outputs.blue_id }}
          fi

      - run: |
          aws ec2 create-tags --resources ${{ needs.provision-green.outputs.green_instance_id }} --tags Key=Environment,Value=blue Key=Name,Value=quotes-app-blue
          aws elbv2 register-targets --target-group-arn ${{ env.BLUE_TG_ARN }} --targets Id=${{ needs.provision-green.outputs.green_instance_id }}
          sleep 15
          aws elbv2 modify-listener --listener-arn ${{ env.ALB_LISTENER_ARN }} --default-actions Type=forward,TargetGroupArn=${{ env.BLUE_TG_ARN }}
          sleep 10
          aws elbv2 deregister-targets --target-group-arn ${{ env.GREEN_TG_ARN }} --targets Id=${{ needs.provision-green.outputs.green_instance_id }}
