name: Blue-Green Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  BLUE_TG_ARN: ${{ secrets.BLUE_TARGET_GROUP_ARN }}
  GREEN_TG_ARN: ${{ secrets.GREEN_TARGET_GROUP_ARN }}
  ALB_LISTENER_ARN: ${{ secrets.ALB_LISTENER_ARN }}
  LAUNCH_TEMPLATE_ID: ${{ secrets.LAUNCH_TEMPLATE_ID }}
  PRIVATE_SUBNET_ID: ${{ secrets.PRIVATE_SUBNET_ID }}

jobs:
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v3

      - name: Set image tag
        id: set_tag
        run: echo "tag=v${{ github.run_number }}-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push images
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          USER=${{ secrets.DOCKER_USERNAME }}

          for SERVICE in db:quotes-db api:quotes-api app:quotes-frontend; do
            DIR=${SERVICE%%:*}
            NAME=${SERVICE##*:}
            docker buildx build --push \
              --cache-from type=registry,ref=$USER/$NAME:buildcache \
              --cache-to type=registry,ref=$USER/$NAME:buildcache,mode=max \
              -t $USER/$NAME:$TAG \
              -t $USER/$NAME:latest \
              ./$DIR
          done

      - name: Prepare deployment files
        run: |
          TAG=${{ steps.set_tag.outputs.tag }}
          USER=${{ secrets.DOCKER_USERNAME }}

          sed -i "s|build: ./db|image: $USER/quotes-db:$TAG|g" docker-compose.yml
          sed -i "s|build: ./api|image: $USER/quotes-api:$TAG|g" docker-compose.yml
          sed -i "s|build: ./app|image: $USER/quotes-frontend:$TAG|g" docker-compose.yml

      - name: Upload deployment files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: |
            docker-compose.yml
            nginx-config/
            deployment/

  provision-green:
    name: Launch Green Instance
    needs: build
    runs-on: ubuntu-latest
    outputs:
      green_instance_id: ${{ steps.launch.outputs.instance_id }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Launch green instance
        id: launch
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --launch-template LaunchTemplateId=${{ env.LAUNCH_TEMPLATE_ID }} \
            --subnet-id ${{ env.PRIVATE_SUBNET_ID }} \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Environment,Value=green},{Key=Version,Value=${{ needs.build.outputs.image_tag }}},{Key=Name,Value=quotes-app-green}]" \
            --query 'Instances[0].InstanceId' --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched: $INSTANCE_ID"

      - name: Wait for SSM agent
        run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.launch.outputs.instance_id }}
          sleep 60
          for i in {1..20}; do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${{ steps.launch.outputs.instance_id }}" \
              --query 'InstanceInformationList[0].PingStatus' --output text 2>/dev/null || echo "Offline")
            [ "$STATUS" = "Online" ] && echo "SSM ready" && exit 0
            echo "Waiting for SSM ($i/20)..."
            sleep 10
          done

  deploy:
    name: Deploy to Green
    needs: [build, provision-green]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v4
        with:
          name: deployment-files

      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Copy files and deploy
        run: |
          INSTANCE_ID=${{ needs.provision-green.outputs.green_instance_id }}
          TAG=${{ needs.build.outputs.image_tag }}
          tar czf deploy.tar.gz docker-compose.yml nginx-config deployment
          ENCODED=$(base64 -w 0 deploy.tar.gz)
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy $TAG" \
            --timeout-seconds 1800 \
            --parameters commands="[
              'set -ex',
              'mkdir -p /home/ubuntu/quotes-app && cd /home/ubuntu/quotes-app',
              'echo \"$ENCODED\" | base64 -d | tar xzf -',
              'chmod +x deployment/*.sh',
              'bash deployment/deploy.sh ${{ secrets.DOCKER_USERNAME }} $TAG ${{ secrets.DOCKER_PASSWORD }} green'
            ]" \
            --query 'Command.CommandId' --output text)
          echo "command_id=$COMMAND_ID" >> $GITHUB_ENV

      - name: Wait for deployment
        run: |
          INSTANCE_ID=${{ needs.provision-green.outputs.green_instance_id }}
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${{ env.command_id }}" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' --output text 2>/dev/null || echo "Pending")
            echo "[$i/60] $STATUS"
            [ "$STATUS" = "Success" ] && echo "Deployment successful" && exit 0
            [[ "$STATUS" =~ ^(Failed|TimedOut|Cancelled)$ ]] && exit 1
            sleep 15
          done
          exit 1

  health-check:
    name: Health Check
    needs: [provision-green, deploy]
    runs-on: ubuntu-latest

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run health check
        run: |
          INSTANCE_ID=${{ needs.provision-green.outputs.green_instance_id }}
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["cd /home/ubuntu/quotes-app && bash deployment/health_check.sh"]' \
            --query 'Command.CommandId' --output text)
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' --output text 2>/dev/null || echo "Pending")
            [ "$STATUS" = "Success" ] && echo "Health check passed" && exit 0
            [[ "$STATUS" =~ ^(Failed|TimedOut)$ ]] && echo "Health check failed" && exit 1
            sleep 10
          done

  register-green:
    name: Register Green
    needs: [provision-green, health-check]
    runs-on: ubuntu-latest

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Register and wait for healthy
        run: |
          INSTANCE_ID=${{ needs.provision-green.outputs.green_instance_id }}
          aws elbv2 register-targets \
            --target-group-arn ${{ env.GREEN_TG_ARN }} \
            --targets Id=$INSTANCE_ID
          echo "Waiting for healthy status..."
          for i in {1..60}; do
            STATE=$(aws elbv2 describe-target-health \
              --target-group-arn ${{ env.GREEN_TG_ARN }} \
              --targets Id=$INSTANCE_ID \
              --query 'TargetHealthDescriptions[0].TargetHealth.State' --output text)
            echo "[$i/60] $STATE"
            [ "$STATE" = "healthy" ] && echo "Target healthy" && exit 0
            [ "$STATE" = "unhealthy" ] && [ $i -gt 30 ] && echo "Target unhealthy" && exit 1
            sleep 15
          done

  configure-canary:
    name: Canary 20%
    needs: [provision-green, register-green]
    runs-on: ubuntu-latest

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure traffic split
        run: |
          aws elbv2 modify-listener \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,ForwardConfig="{\"TargetGroups\":[{\"TargetGroupArn\":\"${{ env.BLUE_TG_ARN }}\",\"Weight\":80},{\"TargetGroupArn\":\"${{ env.GREEN_TG_ARN }}\",\"Weight\":20}]}"
          echo "Traffic: Blue 80%, Green 20%"

  approve:
    name: QA Approval
    needs: configure-canary
    runs-on: ubuntu-latest
    environment: production-approval

    steps:
      - run: echo "Awaiting QA approval"

  complete-deployment:
    name: Complete Deployment
    needs: [provision-green, approve]
    runs-on: ubuntu-latest

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get blue instance
        id: blue
        run: |
          BLUE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=blue" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null || echo "")
          echo "blue_id=$BLUE_ID" >> $GITHUB_OUTPUT

      - name: Route 100% to green
        run: |
          aws elbv2 modify-listener \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ env.GREEN_TG_ARN }}
          echo "Waiting for traffic to stabilize..."
          sleep 45

      - name: Cleanup blue instance
        if: steps.blue.outputs.blue_id != '' && steps.blue.outputs.blue_id != 'None'
        run: |
          aws elbv2 deregister-targets \
            --target-group-arn ${{ env.BLUE_TG_ARN }} \
            --targets Id=${{ steps.blue.outputs.blue_id }}
          sleep 60
          aws ec2 terminate-instances --instance-ids ${{
            steps.blue.outputs.blue_id }}

      - name: Promote green to blue
        run: |
          INSTANCE_ID=${{ needs.provision-green.outputs.green_instance_id }}
          aws ec2 create-tags \
            --resources $INSTANCE_ID \
            --tags Key=Environment,Value=blue Key=Name,Value=quotes-app-blue
          aws elbv2 register-targets \
            --target-group-arn ${{ env.BLUE_TG_ARN }} \
            --targets Id=$INSTANCE_ID
          sleep 30
          aws elbv2 modify-listener \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ env.BLUE_TG_ARN }}
          sleep 15
          aws elbv2 deregister-targets \
            --target-group-arn ${{ env.GREEN_TG_ARN }} \
            --targets Id=$INSTANCE_ID
          echo "Deployment complete"
