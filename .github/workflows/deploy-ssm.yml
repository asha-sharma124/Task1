name: Single Instance Blue-Green Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  BLUE_TG_ARN: ${{ secrets.BLUE_TARGET_GROUP_ARN }}
  GREEN_TG_ARN: ${{ secrets.GREEN_TARGET_GROUP_ARN }}
  ALB_LISTENER_ARN: ${{ secrets.ALB_LISTENER_ARN }}
  LAUNCH_TEMPLATE_ID: ${{ secrets.LAUNCH_TEMPLATE_ID }}
  PRIVATE_SUBNET_ID: ${{ secrets.PRIVATE_SUBNET_ID }}

jobs:
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set image tag
        id: set_tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=v${{ github.run_number }}-${SHORT_SHA}" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Database image
        uses: docker/build-push-action@v4
        with:
          context: ./db
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-db:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-db:latest
      
      - name: Build and push API image
        uses: docker/build-push-action@v4
        with:
          context: ./api
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-api:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-api:latest
      
      - name: Build and push Frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:${{ steps.set_tag.outputs.tag }}
            ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:latest
      
      - name: Upload deployment files to S3
        run: |
          # Update docker-compose.yml with new image tags
          sed -i "s|build: ./db|image: ${{ secrets.DOCKER_USERNAME }}/quotes-db:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml
          sed -i "s|build: ./api|image: ${{ secrets.DOCKER_USERNAME }}/quotes-api:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml
          sed -i "s|build: ./app|image: ${{ secrets.DOCKER_USERNAME }}/quotes-frontend:${{ steps.set_tag.outputs.tag }}|g" docker-compose.yml
          
          # Upload to S3
          aws s3 cp docker-compose.yml s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ steps.set_tag.outputs.tag }}/
          aws s3 cp deployment/ s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ steps.set_tag.outputs.tag }}/deployment/ --recursive
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ env.AWS_REGION }}

  provision-green:
    name: Launch Green Instance
    needs: build
    runs-on: ubuntu-latest
    outputs:
      green_instance_id: ${{ steps.launch.outputs.instance_id }}
      
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Launch single green instance
        id: launch
        run: |
          echo "Launching new green instance..."
          
          INSTANCE_ID=$(aws ec2 run-instances \
            --launch-template LaunchTemplateId=${{ env.LAUNCH_TEMPLATE_ID }} \
            --count 1 \
            --subnet-id ${{ env.PRIVATE_SUBNET_ID }} \
            --tag-specifications "ResourceType=instance,Tags=[
              {Key=Environment,Value=green},
              {Key=Version,Value=${{ needs.build.outputs.image_tag }}},
              {Key=Name,Value=quotes-app-green}
            ]" \
            --query 'Instances[0].InstanceId' \
            --output text)
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "âœ… Launched green instance: $INSTANCE_ID"
      
      - name: Wait for instance to be ready
        run: |
          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids ${{ steps.launch.outputs.instance_id }}
          
          echo "Waiting for SSM agent to be online..."
          sleep 120  # Wait for user data and SSM registration
          
          # Check SSM status
          for i in {1..20}; do
            STATUS=$(aws ssm describe-instance-information \
              --instance-information-filter-list "key=InstanceIds,valueSet=${{ steps.launch.outputs.instance_id }}" \
              --query 'InstanceInformationList[0].PingStatus' \
              --output text 2>/dev/null || echo "Offline")
            
            if [ "$STATUS" = "Online" ]; then
              echo "âœ… SSM agent is online"
              break
            fi
            
            echo "Attempt $i/20 - SSM Status: $STATUS"
            sleep 15
          done

  deploy:
    name: Deploy Application to Green
    needs: [build, provision-green]
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy via SSM
        run: |
          echo "=== Deploying to green instance ==="
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ needs.provision-green.outputs.green_instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy quotes app ${{ needs.build.outputs.image_tag }}" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "echo \"Starting deployment...\"",
              "cd /opt/app",
              "aws s3 cp s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ needs.build.outputs.image_tag }}/docker-compose.yml .",
              "aws s3 cp s3://${{ secrets.DEPLOYMENT_BUCKET }}/deployments/${{ needs.build.outputs.image_tag }}/deployment/ ./deployment/ --recursive",
              "chmod +x deployment/*.sh",
              "bash deployment/deploy.sh ${{ secrets.DOCKER_USERNAME }} ${{ needs.build.outputs.image_tag }} ${{ secrets.DOCKER_PASSWORD }}"
            ]' \
            --timeout-seconds 600 \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for deployment
          echo "Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" || true
          
          # Check status
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" \
            --query 'Status' \
            --output text)
          
          echo "Deployment Status: $STATUS"
          
          if [ "$STATUS" != "Success" ]; then
            echo "âŒ Deployment failed!"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ needs.provision-green.outputs.green_instance_id }}"
            exit 1
          fi
          
          echo "âœ… Deployment successful!"

  health-check:
    name: Health Check Green Instance
    needs: [build, provision-green, deploy]
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run health check
        run: |
          echo "=== Running health check ==="
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ needs.provision-green.outputs.green_instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /opt/app",
              "bash deployment/health_check.sh"
            ]' \
            --timeout-seconds 300 \
            --query 'Command.CommandId' \
            --output text)
          
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" || true
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ needs.provision-green.outputs.green_instance_id }}" \
            --query 'Status' \
            --output text)
          
          if [ "$STATUS" != "Success" ]; then
            echo "âŒ Health check failed!"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ needs.provision-green.outputs.green_instance_id }}"
            exit 1
          fi
          
          echo "âœ… Health check passed!"

  register-green:
    name: Register Green to Load Balancer
    needs: [provision-green, health-check]
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Register to green target group
        run: |
          echo "Registering green instance to target group..."
          
          aws elbv2 register-targets \
            --target-group-arn ${{ env.GREEN_TG_ARN }} \
            --targets Id=${{ needs.provision-green.outputs.green_instance_id }}
          
          echo "Waiting for target to be healthy..."
          
          for i in {1..40}; do
            HEALTH=$(aws elbv2 describe-target-health \
              --target-group-arn ${{ env.GREEN_TG_ARN }} \
              --targets Id=${{ needs.provision-green.outputs.green_instance_id }} \
              --query 'TargetHealthDescriptions[0].TargetHealth.State' \
              --output text)
            
            echo "Attempt $i/40 - Target Health: $HEALTH"
            
            if [ "$HEALTH" = "healthy" ]; then
              echo "âœ… Green instance is healthy in target group!"
              exit 0
            fi
            
            sleep 15
          done
          
          echo "âŒ Target failed to become healthy"
          exit 1

  configure-canary:
    name: Configure 20% Canary Traffic
    needs: [provision-green, register-green]
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set 80% Blue / 20% Green traffic split
        run: |
          echo "Configuring traffic split..."
          
          RULE_ARN=$(aws elbv2 describe-rules \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --query 'Rules[?IsDefault==`true`].RuleArn' \
            --output text)
          
          aws elbv2 modify-rule \
            --rule-arn "$RULE_ARN" \
            --actions Type=forward,ForwardConfig="{
              TargetGroups=[
                {TargetGroupArn=${{ env.BLUE_TG_ARN }},Weight=80},
                {TargetGroupArn=${{ env.GREEN_TG_ARN }},Weight=20}
              ],
              TargetGroupStickinessConfig={Enabled=false}
            }"
          
          echo "âœ… Traffic Distribution:"
          echo "   - Blue (current): 80%"
          echo "   - Green (new): 20%"
          echo ""
          echo "ðŸ§ª Green instance receiving 20% of traffic for testing"

  approve:
    name: QA Approval Gate
    needs: configure-canary
    runs-on: ubuntu-latest
    environment: production-approval
    
    steps:
      - name: Awaiting approval
        run: |
          echo "â¸ï¸  Deployment paused for QA testing"
          echo "ðŸ“Š Current state:"
          echo "   - Blue: 1 instance (80% traffic)"
          echo "   - Green: 1 instance (20% traffic)"
          echo ""
          echo "âœ… Approve to complete deployment (100% â†’ Green)"

  complete-deployment:
    name: Complete Blue-Green Switch
    needs: [provision-green, approve]
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Shift 100% traffic to green
        run: |
          echo "Shifting 100% traffic to green..."
          
          RULE_ARN=$(aws elbv2 describe-rules \
            --listener-arn ${{ env.ALB_LISTENER_ARN }} \
            --query 'Rules[?IsDefault==`true`].RuleArn' \
            --output text)
          
          aws elbv2 modify-rule \
            --rule-arn "$RULE_ARN" \
            --actions Type=forward,TargetGroupArn=${{ env.GREEN_TG_ARN }}
          
          echo "âœ… 100% traffic now on green instance"
      
      - name: Get blue instance ID
        id: blue
        run: |
          BLUE_ID=$(aws ec2 describe-instances \
            --filters \
              "Name=tag:Environment,Values=blue" \
              "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text 2>/dev/null || echo "")
          
          echo "blue_id=$BLUE_ID" >> $GITHUB_OUTPUT
          
          if [ -z "$BLUE_ID" ] || [ "$BLUE_ID" = "None" ]; then
            echo "No blue instance found (first deployment)"
          else
            echo "Blue instance to cleanup: $BLUE_ID"
          fi
      
      - name: Deregister and terminate blue instance
        if: steps.blue.outputs.blue_id != '' && steps.blue.outputs.blue_id != 'None'
        run: |
          echo "Deregistering blue instance from target group..."
          
          aws elbv2 deregister-targets \
            --target-group-arn ${{ env.BLUE_TG_ARN }} \
            --targets Id=${{ steps.blue.outputs.blue_id }} || true
          
          echo "Waiting for connection draining (30 seconds)..."
          sleep 30
          
          echo "Terminating old blue instance..."
          aws ec2 terminate-instances --instance-ids ${{ steps.blue.outputs.blue_id }}
          
          echo "âœ… Old blue instance terminated"
      
      - name: Promote green to blue
        run: |
          echo "Tagging green instance as new blue..."
          
          aws ec2 create-tags \
            --resources ${{ needs.provision-green.outputs.green_instance_id }} \
            --tags Key=Environment,Value=blue Key=Name,Value=quotes-app-blue
          
          echo "âœ… Deployment complete!"
          echo "ðŸŽ‰ Green instance is now the production blue instance"
